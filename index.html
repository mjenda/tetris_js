<!DOCTYPE html>
<html>
<head>
  <title>Tetris</title>
  <style>
    body { font-family: Helvetica, sans-serif; }
    #canvas { display: inline-block; vertical-align: top; box-shadow: 2px 2px 2px #999; border: 1px solid #333;}
  </style>
</head>

<body>
  <div id="tetris">
    <canvas id="canvas" width="400" height="800"></canvas>
  </div>

<script>
    function get(id) {
        return document.getElementById(id);
    }

    function getCanvas() {
        return get('canvas');
    }

    function getContext() {
        return getCanvas().getContext('2d');
    }

    class Painter {
        static drawSquare(startX, startY, size, color) {
            getContext().beginPath();
            getContext().rect(startX,startY,size,size);
            getContext().fillStyle = color;
            getContext().lineWidth = 1;
            getContext().fill();
            getContext().stroke();
            getContext().closePath();
        }

        static drawBox(boxIndexX, boxIndexY, color) {
            this.drawSquare(boxIndexX*40, boxIndexY*40, 40, color);
        }

        static drawTile(tile) {
            this.drawBox(tile.x, tile.y, tile.color);
        }

        static drawStructure(structure) {
            for (var i = 0; i < structure.tiles.length; ++i) {
                this.drawTile(structure.tiles[i]);
            }
        }

        static drawArray(array) {
            for (var i = 0; i < array.length; ++i) {
                this.drawStructure(array[i]);
            }
        }

        static clearCanvas() {
            getContext().clearRect(0, 0, getCanvas().width, getCanvas().height);
            var w = getCanvas().width;
            getCanvas().width = 1;
            getCanvas().width = w;
        }
    }

    class Tile {
        constructor(x, y, color) {
            this.x = x;
            this.y = y;
            this.color = color;
        }
        moveLeft() {
            this.x = this.x - 1;
        }
        moveRight() {
            this.x = this.x + 1;
        }
        moveDown() {
            this.y = this.y + 1;
        }
        touchedTheGround() {
            return (this.y + 1)*40 < getCanvas().height;
        }
    }

    class Block {
        constructor() {
            this.tiles = [];
        }

        moveLeft() {
            for (var i = 0; i < this.tiles.length; ++i) {
                this.tiles[i].moveLeft();
            }
        }
        moveRight() {
            for (var i = 0; i < this.tiles.length; ++i) {
                this.tiles[i].moveRight();
            }
        }
        moveDown() {
            if (this.touchedTheGround()) {
                for (var i = 0; i < this.tiles.length; ++i) {
                    this.tiles[i].moveDown();
                }
            }
        }
        touchedTheGround() {
            for (var i = 0; i < this.tiles.length; ++i) {
                if (!this.tiles[i].touchedTheGround()) {
                    return false;
                }
            }
            return true;
        }
    }

    class BlockS extends Block {
        constructor (x, y, color) {
            super();
            this.tiles = [ new Tile(x,   y,   color),
                           new Tile(x,   y+1, color),
                           new Tile(x+1, y+1, color),
                           new Tile(x+1, y+2, color)];
        }
    }

    class BlockL extends Block {
        constructor (x, y, color) {
            super();
            this.tiles = [ new Tile(x,   y,   color),
                           new Tile(x,   y+1, color),
                           new Tile(x+1, y+1, color),
                           new Tile(x+2, y+1, color)];
        }
    }

    class Game {
        constructor() {
            this.blocks = [new BlockS(1,1, "red"),
                           new BlockL(5,17, "blue")];
            Painter.drawArray(this.blocks);
        }
        moveAndRedraw(index) {
            if (index >= this.blocks.length) {
                return;
            }
            Painter.clearCanvas();
            this.blocks[index].moveDown();
            Painter.drawArray(this.blocks);
        }
    }

    var game = new Game();

</script>
</body>
</html>
