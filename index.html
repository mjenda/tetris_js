<!DOCTYPE html>
<html>
<head>
  <title>Tetris</title>
  <style>
    body { font-family: Helvetica, sans-serif; }
    #canvas { display: inline-block; vertical-align: top; box-shadow: 2px 2px 2px #999; border: 1px solid #333;}
  </style>
</head>

<body>
  <div id="tetris">
    <canvas id="canvas" width="400" height="800"></canvas>
  </div>

<script>
    function get(id) {
        return document.getElementById(id);
    }

    function getCanvas() {
        return get('canvas');
    }

    function getContext() {
        return getCanvas().getContext('2d');
    }

    class Painter {
        static drawSquare(startX, startY, size, color) {
            getContext().beginPath();
            getContext().rect(startX,startY,size,size);
            getContext().fillStyle = color;
            getContext().lineWidth = 0.4;
            getContext().fill();
            getContext().stroke();
            getContext().closePath();
        }

        static drawBox(boxIndexX, boxIndexY, color) {
            this.drawSquare(boxIndexX*40, boxIndexY*40, 40, color);
        }

        static drawTile(tile) {
            this.drawBox(tile.x, tile.y, tile.color);
        }

        static drawStructure(structure) {
            for (var i = 0; i < structure.tiles.length; ++i) {
                this.drawTile(structure.tiles[i]);
            }
        }

        static drawArray(array) {
            for (var i = 0; i < array.length; ++i) {
                this.drawStructure(array[i]);
            }
        }

        static clearCanvas() {
            getContext().clearRect(0, 0, getCanvas().width, getCanvas().height);
            var w = getCanvas().width;
            getCanvas().width = 1;
            getCanvas().width = w;
        }
    }

    class Tile {
        constructor(x, y, color) {
            this.x = x;
            this.y = y;
            this.color = color;
        }
        moveLeft() {
            this.x = this.x - 1;
        }
        moveRight() {
            this.x = this.x + 1;
        }
        moveDown() {
            this.y = this.y + 1;
        }
        moveUp() {
            this.y = this.y - 1;
        }
        touchedTheBottomBorder() {
            return (this.y + 1)*40 >= getCanvas().height;
        }
        touchedTheRightBorder() {
            return (this.x + 1)*40 >= getCanvas().width;
        }
        touchedTheLeftBorder() {
            return this.x - 1 < 0;
        }
    }

    class Block {
        constructor() {
            this.tiles = [];
        }

        moveLeft() {
            if (!this.touchedTheLeftBorder()) {
                for (var i = 0; i < this.tiles.length; ++i) {
                    this.tiles[i].moveLeft();
                }
            }
        }
        moveRight() {
            if (!this.touchedTheRightBorder()) {
                for (var i = 0; i < this.tiles.length; ++i) {
                    this.tiles[i].moveRight();
                }
            }
        }
        moveDown() {
            if (!this.touchedTheBottomBorder()) {
                for (var i = 0; i < this.tiles.length; ++i) {
                    this.tiles[i].moveDown();
                }
            }
        }
        moveUp() {
            for (var i = 0; i < this.tiles.length; ++i) {
                this.tiles[i].moveUp();
            }
        }
        moveDownIfPossible(allBlocks) {
            this.moveDown();
            for (var i = 0; i < allBlocks.length; ++i) {
                if (this.isColidingWithOtherBlock(allBlocks[i])) {
                    this.moveUp();
                    return;
                }
            }
        }
        moveLeftIfPossible(allBlocks) {
            this.moveLeft();
            for (var i = 0; i < allBlocks.length; ++i) {
                if (this.isColidingWithOtherBlock(allBlocks[i])) {
                    this.moveRight();
                    return;
                }
            }
        }
        moveRightIfPossible(allBlocks) {
            this.moveRight();
            for (var i = 0; i < allBlocks.length; ++i) {
                if (this.isColidingWithOtherBlock(allBlocks[i])) {
                    this.moveLeft();
                    return;
                }
            }
        }
        touchedTheBottomLayer(bottomLayer) {
            this.moveDown();
            for (var i = 0; i < bottomLayer.length; ++i) {
                if (this.isColidingWithOtherBlock(bottomLayer[i])) {
                    this.moveUp();
                    return true;
                }
            }
            this.moveUp();
            return false;
        }

        touchedTheGround(bottomLayer) {
            return this.touchedTheBottomBorder() || this.touchedTheBottomLayer(bottomLayer);
        }
        touchedTheBottomBorder() {
            for (var i = 0; i < this.tiles.length; ++i) {
                if (this.tiles[i].touchedTheBottomBorder()) {
                    return true;
                }
            }
            return false;
        }
        touchedTheRightBorder() {
            for (var i = 0; i < this.tiles.length; ++i) {
                if (this.tiles[i].touchedTheRightBorder()) {
                    return true;
                }
            }
            return false;
        }
        touchedTheLeftBorder() {
            for (var i = 0; i < this.tiles.length; ++i) {
                if (this.tiles[i].touchedTheLeftBorder()) {
                    return true;
                }
            }
            return false;
        }
        isColidingWithOtherBlock(otherBlock) {
            for (var i = 0; i < this.tiles.length; ++i) {
                for (var j = 0; j < otherBlock.tiles.length; ++j) {
                    if (this.tiles[i].x == otherBlock.tiles[j].x &&
                        this.tiles[i].y == otherBlock.tiles[j].y) {
                        return true;
                    }
                }
            }
            return false;
        }
    }

    class BlockS extends Block {
        constructor (x, y, color) {
            super();
            this.tiles = [ new Tile(x+1, y,   color),
                           new Tile(x+2, y, color),
                           new Tile(x,   y+1, color),
                           new Tile(x+1, y+1, color)];
        }
    }

    class BlockZ extends Block {
        constructor (x, y, color) {
            super();
            this.tiles = [ new Tile(x,   y,   color),
                           new Tile(x+1, y,   color),
                           new Tile(x+1, y+1, color),
                           new Tile(x+2, y+1, color)];
        }
    }

    class BlockL extends Block {
        constructor (x, y, color) {
            super();
            this.tiles = [ new Tile(x,   y,   color),
                           new Tile(x,   y+1, color),
                           new Tile(x+1, y+1, color),
                           new Tile(x+2, y+1, color)];
        }
    }

    class BlockI extends Block {
        constructor (x, y, color) {
            super();
            this.tiles = [ new Tile(x,   y, color),
                           new Tile(x+1, y, color),
                           new Tile(x+2, y, color),
                           new Tile(x+3, y, color)];
        }
    }

    class BlockO extends Block {
        constructor (x, y, color) {
            super();
            this.tiles = [ new Tile(x,   y,   color),
                           new Tile(x+1, y,   color),
                           new Tile(x,   y+1, color),
                           new Tile(x+1, y+1, color)];
        }
    }

    class BlockT extends Block {
        constructor (x, y, color) {
            super();
            this.tiles = [ new Tile(x,   y,   color),
                           new Tile(x+1, y,   color),
                           new Tile(x+2, y,   color),
                           new Tile(x+1, y+1, color)];
        }
    }

    class BlockBuilder {
        static buildS(x, y, color) {
            return new BlockS(x, y, color);
        }
        static buildZ(x, y, color) {
            return new BlockZ(x, y, color);
        }
        static buildL(x, y, color) {
            return new BlockL(x, y, color);
        }
        static buildI(x, y, color) {
            return new BlockI(x, y, color);
        }
        static buildO(x, y, color) {
            return new BlockO(x, y, color);
        }
        static buildT(x, y, color) {
            return new BlockT(x, y, color);
        }
    }

    class KeyboardHandler {
        constructor(game) {
            this.game = game;
            document.addEventListener('keydown', function(event) {
                if(event.keyCode == 37) {
                    game.moveLeftAndRedraw();
                }
                else if(event.keyCode == 39) {
                    game.moveRightAndRedraw();
                }
                else if (event.keyCode == 40) {
                    game.moveDownAndRedraw();
                }
            });
        }
    }

    class Game {
        constructor() {
            this.keyboardHandler = new KeyboardHandler(this);
            this.activeBlock = BlockBuilder.buildZ(1,1, "red");
            this.bottomLayer = [BlockBuilder.buildL(5,18, "blue")];
            this.redraw();
        }
        moveDownAndRedraw() {
            if (this.activeBlock.touchedTheGround(this.bottomLayer)) {
                this.spawnNewActiveBlock();
                return;
            }

            Painter.clearCanvas();
            this.activeBlock.moveDownIfPossible(this.bottomLayer);
            this.redraw();
        }

        moveLeftAndRedraw() {
            Painter.clearCanvas();
            this.activeBlock.moveLeftIfPossible(this.bottomLayer);
            this.redraw();
        }

        moveRightAndRedraw() {
            Painter.clearCanvas();
            this.activeBlock.moveRightIfPossible(this.bottomLayer);
            this.redraw();
        }

        spawnNewActiveBlock() {
            this.bottomLayer.push(this.activeBlock);
            this.activeBlock = BlockBuilder.buildS(1,1, "red");
            this.redraw();
        }
        redraw() {
            Painter.drawArray(this.bottomLayer);
            Painter.drawStructure(this.activeBlock);
        }
    }

    var game = new Game();


</script>
</body>
</html>
